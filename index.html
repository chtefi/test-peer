<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Test-peer by chtefi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <style>
    ul,
    li {
        list-style-type: none;
        margin: 0;
        padding: 0;
    }
    li {
        width: 400px;
        height: 400px;
        float: left;
        margin: 10px;
        border: 1px solid #ccc;
    }
    li video {
        width: 100%;
        height: 100%;
    }
    li:first-child {
        background: blue;
        padding: 10px;
    }
    </style>
</head>

<body>

    <ul>
        <li>
            <video autoplay id="yourself"></video>
        </li>
    </ul>

    <script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src='http://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
    <script src="http://cdn.peerjs.com/0.3.9/peer.js"></script>

    <script>
    var repo = new Firebase('https://dazzling-fire-8759.firebaseio.com');
    var peer = new Peer({
        key: 'rv3o73w5cgix80k9'
    });
    var connectedTo = [];

    peer.on('open', function(id) {
        var newPeerIdRef = repo.push();
        newPeerIdRef.set({
            peerId: id
        });
        newPeerIdRef.onDisconnect().remove();
        $('body').prepend('peer ' + id + ' opened!');
    });

    peer.on('connection', function(conn) {
        //console.log('Someone connected', conn.peer);
    });

    peer.on('error', function(err) {
        $('body').prepend('Peer error: ' + err);
    })

    // if someone is calling us, we respond !
    var getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia).bind(navigator);
    var myStream = null;

    var url = window.URL || window.webkitURL;

    // get current user stream
    getUserMedia({
        video: true,
        audio: false
    }, function(stream) {        
        myStream = stream;
        $('video#yourself').attr('src', url ? url.createObjectURL(stream) : stream);

        initRepo();
    }, function(err) {
        console.error(err);
        $('video#yourself').parent().text('cannot display your stream: ' + err.name);
        initRepo();
    });

    peer.on('call', function(call) {
        var fromPeerId = call.peer;
        $('body').prepend('getting a call from ' + fromPeerId + '<br>');
        console.log('getting a call from ' + fromPeerId);
        call.answer(myStream);
        call.on('stream', function(stream) {
            $('body').prepend('getting the stream call from ' + fromPeerId + '<br>');
            var item = $('li[peer=' + fromPeerId + ']');
            var video = $('<video autoplay>').appendTo(item);
            video.attr('src', url.createObjectURL(stream));
        });
    });

    function initRepo() {

        repo.on('child_added', function(payload) {
            var message = payload.val();
            console.log('child_added | peer.connect to ', message.peerId);
            var conn = peer.connect(message.peerId);

            conn.on('open', function() {
                $('body').prepend('connection done to ' + conn.peer + '<br>');
                call(conn);
            });

            conn.on('error', function(err) {
                console.log('cannot connect to peer', err);
            });
        });

        repo.on('child_removed', function(payload) {
            var message = payload.val();
            console.log('child_removed | peer.disconnect from ', message.peerId);
            var gonePeer = connectedTo.filter(function(p) {
                return p.peer === message.peerId;
            });
            connectedTo.splice(connectedTo.indexOf(gonePeer), 1);
            $('li[peer=' + message.peerId + ']').remove();
        });
    }


    function call(conn) {
        // model + dom
        connectedTo.push(conn);
        var item = $('<li>').attr('peer', conn.peer).text(conn.peer).appendTo($('ul'));

        $('body').prepend('can call ? ' + myStream + '<br>');
        if (myStream) {
            $('body').prepend('calling ' + conn.peer + ' with my stream<br>');
            peer.call(conn.peer, myStream);
        }
    }
    </script>

</body>

</html>
