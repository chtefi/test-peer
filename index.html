<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Test-peer by chtefi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">


    <style>
    ul,
    li {
        list-style-type: none;
        margin: 0;
        padding: 0;
    }
    li {
        width: 200px;
        height: 200px;
        float: left;
        margin: 10px;
        border: 1px solid #ccc;
    }
    li video {
        width: 100%;
        height: 100%;
    }
    </style>
</head>

<body>

    <ul></ul>

    <script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src='//cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
    <script src="//cdn.peerjs.com/0.3.9/peer.js"></script>

    <script>
    var repo = new Firebase('https://dazzling-fire-8759.firebaseio.com');
    var peer = new Peer({
        key: 'rv3o73w5cgix80k9'
    });
    var connectedTo = [];

    peer.on('open', function(id) {
        var newPeerIdRef = repo.push();
        newPeerIdRef.set({
            peerId: id
        });
        newPeerIdRef.onDisconnect().remove();
        $('body').prepend('connected!');
    });

    peer.on('connection', function(conn) {
        //console.log('Someone connected', conn.peer);
    });

    peer.on('error', function(err) {
      $('body').prepend('Peer error: ' + err);
    })

    // if someone is calling us, we respond !
    var getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia).bind(navigator);
    peer.on('call', function(call) {
        getUserMedia({
            video: true,
            audio: true
        }, function(stream) {
            call.answer(stream); // Answer the call with an A/V stream.
            // we don't need to show our stream
            //call.on('stream', function(remoteStream) {
            // Show stream in some video/canvas element.
            //});
        }, function(err) {
            console.err("error while responding to a call", err);
        });
    });

    repo.on('child_added', function(payload) {
        var message = payload.val();
        console.log('child_added | peer.connect to ', message.peerId);
        var conn = peer.connect(message.peerId);

        conn.on('open', function() {
            // // Receive messages
            // conn.on('data', function(data) {
            //     console.log('Received', data);
            // });

            // // Send messages
            // conn.send('Hello!');
            console.log('connection done to', conn.peer)
            call(conn);
        });

        conn.on('error', function(err) {
            console.log('cannot connect to peer', err);
        });
    });

    repo.on('child_removed', function(payload) {
        var message = payload.val();
        console.log('child_removed | peer.disconnect from ', message.peerId);
        var gonePeer = connectedTo.filter(function(p) {
            return p.peer === message.peerId;
        });
        connectedTo.splice(connectedTo.indexOf(gonePeer), 1);
        $('li[peer=' + message.peerId + ']').remove();
    });


    function call(conn) {
        // model + dom
        connectedTo.push(conn);
        var item = $('<li>').attr('peer', conn.peer).text(conn.peer).appendTo($('ul'));

        // what do you look like ?
        getUserMedia({
            video: true,
            audio: true
        }, function(stream) {
            var call = peer.call(conn.peer, stream);

            call.on('stream', function(remoteStream) {
                var video = $('<video>', {
                    src: window.URL.createObjectURL(stream)
                }).appendTo(item);
                video[0].play();
                console.log('streaming ok with', conn.peer);
            });
        }, function(err) {
            console.error('cannot stream with', conn.peer, ':', err);
            item.text('No stream: ' + err.name);
        });
    }
    </script>

</body>

</html>
